name: govulncheck

on:
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/govulncheck.yaml'

permissions:
  contents: read

jobs:
  govulncheck:
    name: govulncheck
    runs-on:
      - self-hosted-ghr
      - size-m-x64
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/workflows/go-setup
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        run: |
          set +e
          OUTPUT=$(govulncheck ./... 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "No vulnerabilities found"
            exit 0
          fi

          # Only GO-2026-4479 (pion/dtls/v2) is expected — it has no fix available.
          # Check that this is the ONLY vulnerability reported.
          if echo "$OUTPUT" | grep -q "Your code is affected by 1 vulnerability" && \
             echo "$OUTPUT" | grep -q "GO-2026-4479"; then
            echo ""
            echo "Only known unfixable vulnerability GO-2026-4479 (pion/dtls/v2) found — no fix available"
            exit 0
          fi

          echo ""
          echo "New vulnerabilities found! Please fix them before merging."
          exit 1
